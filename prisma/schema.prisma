// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication Models
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  companies     CompanyUser[]
  notifications Notification[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@map("password_reset_tokens")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  alertEvent AlertEvent?

  @@index([userId, createdAt])
  @@index([userId, read])
  @@map("notifications")
}

// ============================================
// Company & Business Models
// ============================================

model Company {
  id          String   @id @default(cuid())
  name        String
  industry    String?
  website     String?
  phoneNumber String?
  timezone    String   @default("America/New_York")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users             CompanyUser[]
  marketingChannels MarketingChannel[]
  campaigns         Campaign[]
  adSpends          AdSpend[]
  calls             Call[]
  bookings          Booking[]
  integrations      Integration[]
  alertThresholds   AlertThreshold[]
  anomalyRules      AnomalyDetectionRule[]
  alertEvents       AlertEvent[]

  @@map("companies")
}

model CompanyUser {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  role      String   @default("member")
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_users")
}

// ============================================
// Marketing Channel Models
// ============================================

model MarketingChannel {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  type        String
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company         Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  campaigns       Campaign[]
  adSpends        AdSpend[]
  calls           Call[]
  bookings        Booking[]
  touchpoints     TouchPoint[]
  alertThresholds AlertThreshold[]
  anomalyRules    AnomalyDetectionRule[]
  alertEvents     AlertEvent[]

  @@map("marketing_channels")
}

// ============================================
// Campaign & Ad Spend Models
// ============================================

model Campaign {
  id                String    @id @default(cuid())
  companyId         String
  channelId         String
  name              String
  externalId        String?
  status            String    @default("active")
  startDate         DateTime
  endDate           DateTime?
  targetAudience    String?
  targetGeography   String?
  campaignObjective String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channel         MarketingChannel @relation(fields: [channelId], references: [id])
  adSpends        AdSpend[]
  touchpoints     TouchPoint[]
  alertThresholds AlertThreshold[]
  alertEvents     AlertEvent[]

  @@map("campaigns")
}

model AdSpend {
  id                String   @id @default(cuid())
  companyId         String
  channelId         String
  campaignId        String?
  date              DateTime
  amount            Float
  impressions       Int      @default(0)
  clicks            Int      @default(0)
  conversions       Int      @default(0)
  costPerClick      Float?
  costPerConversion Float?
  clickThroughRate  Float?
  conversionRate    Float?
  externalData      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company  Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channel  MarketingChannel @relation(fields: [channelId], references: [id])
  campaign Campaign?        @relation(fields: [campaignId], references: [id])

  @@unique([companyId, channelId, campaignId, date])
  @@index([companyId, date])
  @@map("ad_spends")
}

// ============================================
// Call Tracking Models
// ============================================

model Call {
  id              String   @id @default(cuid())
  companyId       String
  channelId       String?
  phoneNumber     String
  callerName      String?
  duration        Int?
  status          String
  recordingUrl    String?
  transcription   String?
  sentiment       String?
  leadQuality     String?
  leadScore       Float?
  tags            String?
  callDate        DateTime
  attributedValue Float?
  externalId      String?
  metadata        String?
  createdAt       DateTime @default(now())

  company Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channel MarketingChannel? @relation(fields: [channelId], references: [id])
  booking Booking?

  @@index([companyId, callDate])
  @@index([companyId, status])
  @@map("calls")
}

// ============================================
// Booking & Revenue Models
// ============================================

model Booking {
  id            String    @id @default(cuid())
  companyId     String
  channelId     String?
  callId        String?   @unique
  customerName  String
  customerEmail String?
  customerPhone String?
  serviceName   String
  bookingDate   DateTime
  scheduledDate DateTime
  completedDate DateTime?
  status        String
  revenue       Float?
  cost          Float?
  profit        Float?
  notes         String?
  externalId    String?
  metadata      String?

  // Attribution fields
  firstTouchChannelId String?
  lastTouchChannelId  String?
  attributionModel    String  @default("last-touch")
  attributionData     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channel     MarketingChannel? @relation(fields: [channelId], references: [id])
  call        Call?             @relation(fields: [callId], references: [id])
  touchpoints TouchPoint[]

  @@index([companyId, bookingDate])
  @@index([companyId, status])
  @@map("bookings")
}

// ============================================
// Attribution & TouchPoint Models
// ============================================

model TouchPoint {
  id             String   @id @default(cuid())
  bookingId      String
  channelId      String
  campaignId     String?
  touchpointType String
  timestamp      DateTime
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmContent     String?
  utmTerm        String?
  clickId        String?
  metadata       String?
  createdAt      DateTime @default(now())

  booking  Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  channel  MarketingChannel @relation(fields: [channelId], references: [id])
  campaign Campaign?        @relation(fields: [campaignId], references: [id])

  @@index([bookingId, timestamp])
  @@index([channelId, timestamp])
  @@map("touchpoints")
}

// ============================================
// Integration Models
// ============================================

model Integration {
  id            String    @id @default(cuid())
  companyId     String
  type          String
  name          String
  isActive      Boolean   @default(true)
  credentials   String
  config        String?
  lastSyncedAt  DateTime?
  syncFrequency String    @default("daily")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  syncLogs SyncLog[]

  @@unique([companyId, type])
  @@map("integrations")
}

model SyncLog {
  id            String    @id @default(cuid())
  integrationId String
  status        String
  recordsSynced Int       @default(0)
  errorMessage  String?
  startedAt     DateTime
  completedAt   DateTime?
  metadata      String?

  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, startedAt])
  @@map("sync_logs")
}

model AlertThreshold {
  id          String  @id @default(cuid())
  companyId   String
  name        String
  description String?

  // What to monitor
  metric     String // "roas", "cpc", "ctr", "spend", "conversions", "calls", "bookings"
  channelId  String? // null = all channels, specific = single channel
  campaignId String? // null = all campaigns, specific = single campaign

  // Threshold condition
  operator  String // "less_than", "greater_than", "percent_decrease", "percent_increase"
  threshold Float // The value to compare against

  // Time window for evaluation
  lookbackDays Int @default(1) // Compare against last N days

  // Alert behavior
  isActive Boolean @default(true)
  severity String  @default("medium") // "low", "medium", "high", "critical"

  // Notification settings
  notifyEmail Boolean @default(true)
  notifyInApp Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channel  MarketingChannel? @relation(fields: [channelId], references: [id], onDelete: Cascade)
  campaign Campaign?         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  events   AlertEvent[]

  @@index([companyId, isActive])
  @@index([channelId])
  @@map("alert_thresholds")
}

model AnomalyDetectionRule {
  id          String  @id @default(cuid())
  companyId   String
  name        String
  description String?

  // Detection configuration
  type      String // "zscore", "iqr", "trend_reversal", "sudden_spike", "gradual_decline"
  metric    String // "roas", "cpc", "ctr", "spend", "conversions"
  channelId String? // null = all channels

  // Algorithm parameters
  sensitivity   Float @default(0.7) // 0-1: how aggressive (0.5 = balanced, 0.8 = very sensitive)
  windowDays    Int   @default(30) // Historical data window for baseline
  minDataPoints Int   @default(7) // Minimum data points required

  // Behavior
  isActive Boolean @default(true)
  severity String  @default("medium")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channel MarketingChannel? @relation(fields: [channelId], references: [id], onDelete: Cascade)
  events  AlertEvent[]

  @@index([companyId, isActive])
  @@map("anomaly_detection_rules")
}

model AlertEvent {
  id        String @id @default(cuid())
  companyId String

  // Source of alert
  thresholdId   String?
  anomalyRuleId String?

  // Alert details
  alertType     String // "threshold_violation", "anomaly_detected"
  metric        String // Which metric triggered
  metricValue   Float // Current value
  baselineValue Float? // Expected/baseline value
  deviation     Float? // How far from baseline (for anomalies)

  // Context
  channelId     String?
  campaignId    String?
  dateTriggered DateTime // Which date's data caused alert

  // Notification tracking
  notificationId String? @unique
  severity       String  @default("medium")

  // User interaction
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?
  acknowledgedBy String?
  snoozedUntil   DateTime?

  createdAt DateTime @default(now())

  company      Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  threshold    AlertThreshold?       @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  anomalyRule  AnomalyDetectionRule? @relation(fields: [anomalyRuleId], references: [id], onDelete: Cascade)
  channel      MarketingChannel?     @relation(fields: [channelId], references: [id])
  campaign     Campaign?             @relation(fields: [campaignId], references: [id])
  notification Notification?         @relation(fields: [notificationId], references: [id])

  @@index([companyId, dateTriggered])
  @@index([thresholdId])
  @@index([anomalyRuleId])
  @@index([acknowledged])
  @@map("alert_events")
}
